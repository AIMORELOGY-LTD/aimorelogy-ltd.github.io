name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install deps
        run: npm ci
      - name: Build
        run: npm run build
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
      - name: Prerender
        env:
          CHROME_BIN: ${{ env.CHROME_BIN }}
        run: npm run prerender
      - name: Configure Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Submit IndexNow
        run: |
          python - <<'PY'
          import json
          import urllib.request
          import xml.etree.ElementTree as ET
          
          key = "bd2a90d519a347e19e2af9dbe2a5f5c7"
          host = "https://aimorelogy.com"
          sitemap_url = f"{host}/sitemap.xml"
          
          try:
              with urllib.request.urlopen(sitemap_url, timeout=20) as resp:
                  xml_data = resp.read()
          except Exception as exc:
              print("IndexNow: failed to fetch sitemap:", exc)
              raise SystemExit(0)
          
          root = ET.fromstring(xml_data)
          ns = {"ns": "http://www.sitemaps.org/schemas/sitemap/0.9"}
          urls = []
          for url in root.findall("ns:url", ns):
              loc = url.find("ns:loc", ns)
              if loc is not None and loc.text:
                  urls.append(loc.text.strip())
          
          if not urls:
              print("IndexNow: no URLs found in sitemap.")
              raise SystemExit(0)
          
          payload = {
              "host": "aimorelogy.com",
              "key": key,
              "urlList": urls
          }
          
          data = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(
              "https://api.indexnow.org/indexnow",
              data=data,
              headers={"Content-Type": "application/json; charset=utf-8"}
          )
          
          try:
              with urllib.request.urlopen(req, timeout=20) as resp:
                  print("IndexNow status:", resp.status)
                  print(resp.read().decode("utf-8"))
          except Exception as exc:
              print("IndexNow: submit failed:", exc)
              raise SystemExit(0)
          PY
